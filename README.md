# phalcon-project
[![Total Downloads](https://poser.pugx.org/limingxinleo/phalcon-project/downloads)](https://packagist.org/packages/limingxinleo/phalcon-project)
[![Latest Stable Version](https://poser.pugx.org/limingxinleo/phalcon-project/v/stable)](https://packagist.org/packages/limingxinleo/phalcon-project)
[![Latest Unstable Version](https://poser.pugx.org/limingxinleo/phalcon-project/v/unstable)](https://packagist.org/packages/limingxinleo/phalcon-project)
[![License](https://poser.pugx.org/limingxinleo/phalcon-project/license)](https://packagist.org/packages/limingxinleo/phalcon-project)


[Phalcon 官网](https://docs.phalconphp.com/zh/latest/index.html)

[wiki](https://github.com/limingxinleo/simple-subcontrollers.phalcon/wiki)

## 安装
* 使用Composer安装Thrift扩展后，把go的扩展包拷贝到GOPATH中(或建立软连接)。
~~~
ln -s  /your/path/to/thrift-go-phalcon-project/vendor/apache/thrift/lib/go/thrift thrift
~~~
* 编译Go服务 使用 thrift -r --gen go:thrift_import=thrift App.thrift
* 编译Php服务 使用 thrift -r --gen php:server App.thrift

## Go&Swoole RPC 服务
* Go
thrift/gen-go/main.go
~~~
# RPC服务注册方法
server.RegisterProcessor("app", service.NewAppProcessor(&impl.App{}));
~~~

* Swoole
app/tasks/Thrift/Service.php
~~~
$handler = new AppHandler();
$processor->registerProcessor('app', new AppProcessor($handler));
~~~

## 服务实现
* Swoole
app/thrift/Services/AppHandle.php
~~~php
<?php 
namespace App\Thrift\Services;

use MicroService\AppIf;

class AppHandler extends Handler implements AppIf
{
    public function version()
    {
        return $this->config->version;
    }

}
~~~

## 服务发现
配合[注册中心](https://github.com/limingxinleo/service-registry-swoole-phalcon.git)一起使用
app/tasks/Thrift/ServiceTask.php
~~~
protected function beforeServerStart(swoole_server $server)
{
    parent::beforeServerStart($server); // TODO: Change the autogenerated stub

    // 增加服务注册心跳进程
    $worker = new swoole_process(function (swoole_process $worker) {
        $client = new swoole_client(SWOOLE_SOCK_TCP);
        if (!$client->connect(env('REGISTRY_IP'), env('REGISTRY_PORT'), -1)) {
            exit("connect failed. Error: {$client->errCode}\n");
        }
        swoole_timer_tick(5000, function () use ($client) {
            $service = env('REGISTRY_SERVICE', 'github');
            $data = [
                'service' => $service,
                'ip' => env('SERVICE_IP'),
                'port' => env('SERVICE_PORT'),
                'nonce' => time(),
                'register' => true,
                'sign' => 'xxx',
            ];

            $client->send(json_encode($data));
            $result = $client->recv();

            $result = json_decode($result, true);
            if ($result['success']) {
                foreach ($result['services'] as $key => $item) {
                    Redis::hset($service, $key, json_encode($item));
                }
            }
        });
    });

    $server->addProcess($worker);
}

~~~



